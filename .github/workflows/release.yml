name: Create Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v0.1.0)'
        required: true
        default: 'v0.1.0'
      prerelease:
        description: 'Is this a prerelease?'
        required: true
        type: boolean
        default: true

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build and Create Binaries
        uses: espressif/esp-idf-ci-action@v1.1.0
        with:
          esp_idf_version: latest
          target: esp32p4
          path: '.'
          command: |
            cp sdkconfig.defaults sdkconfig &&
            idf.py build &&
            cd build &&
            # Copy individual binaries for manual flashing
            cp bootloader/bootloader.bin ../bootloader-${{ github.event.inputs.version }}-esp32_p4_function_ev_board-bootloader.bin &&
            cp partition_table/partition-table.bin ../bootloader-${{ github.event.inputs.version }}-esp32_p4_function_ev_board-partition-table.bin &&
            cp esp32_p4_graphical_bootloader.bin ../bootloader-${{ github.event.inputs.version }}-esp32_p4_function_ev_board-factory.bin &&
            # Create merged binary for ESP-Launchpad (without OTA data)
            esptool.py --chip esp32p4 merge_bin -o ../bootloader-${{ github.event.inputs.version }}-esp32_p4_function_ev_board.bin \
              0x2000 bootloader/bootloader.bin \
              0x10000 partition_table/partition-table.bin \
              0x20000 esp32_p4_graphical_bootloader.bin

      - name: Setup gh CLI
        run: |
          # Install gh CLI if not present
          if ! command -v gh &> /dev/null; then
            sudo apt-get update
            sudo apt-get install -y gh
          fi

          # Authenticate with GitHub
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Create Release Notes
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          # ESP32-P4 Graphical Bootloader ${{ github.event.inputs.version }}

          ## Features
          - Touch-enabled GUI bootloader with RTC-based partition switching
          - Factory-first boot design with dynamic partition mapping
          - JSON configuration management with SPIFFS storage
          - Support for up to 16 OTA partitions
          - ESP-Launchpad web-based flashing support

          ## Binary Files
          - **Merged Binary**: Complete firmware image for ESP-Launchpad
          - **Separate Binaries**: Bootloader, partition table, and factory app for manual flashing

          ### Flash Memory Layout
          - **Bootloader**: 8KB
          - **Partition Table**: 4KB
          - **Factory App**: ~577KB
          - **SPIFFS Config**: 2MB (for configuration and icons)

          ### Supported Hardware
          - ESP32-P4 Function EV Board
          - Touchscreen display
          - 16MB Flash (recommended)

          ## Web Flashing
          Visit https://georgik.github.io/esp32-p4-graphical-bootloader/ for browser-based flashing!

          For detailed documentation, visit: https://github.com/georgik/esp32-p4-graphical-bootloader
          EOF

          # Create release flags
          RELEASE_FLAGS=""
          if [[ "${{ github.event.inputs.prerelease }}" == "true" ]]; then
            RELEASE_FLAGS="--prerelease"
          fi

          # Create release
          echo "Creating release ${{ github.event.inputs.version }}..."
          gh release create "${{ github.event.inputs.version }}" \
            --title "ESP32-P4 Graphical Bootloader ${{ github.event.inputs.version }}" \
            --notes-file RELEASE_NOTES.md \
            $RELEASE_FLAGS

      - name: Upload Release Assets
        run: |
          echo "Uploading release assets..."

          # Upload merged binary for ESP-Launchpad
          gh release upload "${{ github.event.inputs.version }}" \
            bootloader-${{ github.event.inputs.version }}-esp32_p4_function_ev_board.bin \
            --clobber

          # Upload separate binaries for manual flashing
          gh release upload "${{ github.event.inputs.version }}" \
            bootloader-${{ github.event.inputs.version }}-esp32_p4_function_ev_board-bootloader.bin \
            --clobber

          gh release upload "${{ github.event.inputs.version }}" \
            bootloader-${{ github.event.inputs.version }}-esp32_p4_function_ev_board-partition-table.bin \
            --clobber

          gh release upload "${{ github.event.inputs.version }}" \
            bootloader-${{ github.event.inputs.version }}-esp32_p4_function_ev_board-factory.bin \
            --clobber

          echo "âœ… Release ${{ github.event.inputs.version }} created successfully!"