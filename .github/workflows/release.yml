name: Create Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'Is this a prerelease?'
        required: true
        type: boolean
        default: true

env:
  TARGET: esp32p4
  BOARD: esp32_p4_function_ev_board

jobs:
  create-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup gh CLI
        run: |
          # Install gh CLI if not present
          if ! command -v gh &> /dev/null; then
            sudo apt-get update
            sudo apt-get install -y gh
          fi

          # Authenticate with GitHub
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Create or Update Release
        run: |
          RELEASE_NOTES=$(cat <<'EOF'
          ## ESP32-P4 Graphical Bootloader Release ${{ github.event.inputs.version }}

          ### Features
          - ‚úÖ Touch-enabled GUI bootloader with Raylib graphics
          - ‚úÖ RTC-based partition switching (factory-first design)
          - ‚úÖ JSON configuration management with SPIFFS storage
          - ‚úÖ Dynamic partition mapping (supports up to 16 OTA partitions)
          - ‚úÖ Web-based flashing via ESP-Launchpad

          ### Flashing Instructions
          1. **Web Flashing**: Visit https://georgik.github.io/esp32-p4-graphical-bootloader/
          2. **Manual Flashing**: Download the release files and use the provided flashing script
          3. **Command Line**: `gh release download ${{ github.event.inputs.version }} && ./flash-esp32_p4_function_ev_board.sh`

          ### Partition Layout
          - **Factory App**: 1MB (GUI bootloader)
          - **OTA_0**: 4.8MB (largest OTA slot)
          - **OTA_1**: 4MB
          - **OTA_2**: 4MB
          - **Config Storage**: 2MB SPIFFS for JSON configs and icons
          - **NVS**: 32KB
          - **OTA Data**: 8KB

          ### Supported Hardware
          - ESP32-P4 Function EV Board
          - Touchscreen display
          - 16MB Flash (recommended)

          For detailed documentation, visit: https://github.com/georgik/esp32-p4-graphical-bootloader
          EOF
          )

          # Create release flags
          RELEASE_FLAGS=""
          if [[ "${{ github.event.inputs.prerelease }}" == "true" ]]; then
            RELEASE_FLAGS="--prerelease"
          fi

          # Check if release exists and create or update accordingly
          if gh release view "${{ github.event.inputs.version }}" > /dev/null 2>&1; then
            echo "Release exists, updating..."
            gh release edit "${{ github.event.inputs.version }}" \
              --title "ESP32-P4 Graphical Bootloader ${{ github.event.inputs.version }}" \
              --notes "$RELEASE_NOTES" \
              $RELEASE_FLAGS
          else
            echo "Creating new release..."
            gh release create "${{ github.event.inputs.version }}" \
              --title "ESP32-P4 Graphical Bootloader ${{ github.event.inputs.version }}" \
              --notes "$RELEASE_NOTES" \
              $RELEASE_FLAGS
          fi

  build-and-upload:
    needs: create-release
    runs-on: ubuntu-latest
    strategy:
      matrix:
        board: [esp32_p4_function_ev_board]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup ESP-IDF and gh CLI
        uses: espressif/esp-idf-action@v1.2.0
        with:
          esp-idf-version: v5.5

      - name: Setup gh CLI for release uploads
        run: |
          # Install gh CLI if not present
          if ! command -v gh &> /dev/null; then
            sudo apt-get update
            sudo apt-get install -y gh
          fi

          # Authenticate with GitHub
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Build Project
        run: |
          # Clean previous builds
          idf.py fullclean

          # Build the project
          idf.py build

          # Create firmware directory
          mkdir -p firmware

          # Copy individual binary files for ESP-Launchpad
          cp build/bootloader/bootloader.bin firmware/bootloader-${{ github.event.inputs.version }}-${{ matrix.board }}-bootloader.bin
          cp build/partition_table/partition-table.bin firmware/bootloader-${{ github.event.inputs.version }}-${{ matrix.board }}-partition-table.bin
          cp build/esp32_p4_graphical_bootloader.bin firmware/bootloader-${{ github.event.inputs.version }}-${{ matrix.board }}-factory.bin
          cp build/ota_data_initial.bin firmware/bootloader-${{ github.event.inputs.version }}-${{ matrix.board }}-ota-data.bin

          # Create flashing package
          tar -czf firmware/bootloader-${{ github.event.inputs.version }}-${{ matrix.board }}.tar.gz \
            build/bootloader/bootloader.bin \
            build/partition_table/partition-table.bin \
            build/esp32_p4_graphical_bootloader.bin \
            build/ota_data_initial.bin \
            partitions.csv \
            README.md

          # Generate flashing script for standard ESP-IDF flashing
          cat > firmware/flash-${{ matrix.board }}.sh << 'EOF'
          #!/bin/bash
          echo "Flashing ESP32-P4 Graphical Bootloader"
          echo "======================================"
          echo "Version: ${{ github.event.inputs.version }}"
          echo ""

          # Detect port automatically
          if command -v esptool.py &> /dev/null; then
              ESP_TOOL="esptool.py"
          else
              ESP_TOOL="python -m esptool"
          fi

          echo "Using: $ESP_TOOL"
          echo ""

          # Detect port (try common ports)
          PORTS=("/dev/ttyUSB0" "/dev/ttyUSB1" "/dev/ttyACM0" "/dev/ttyACM1" "/dev/cu.usbserial-*" "/dev/cu.usbmodem-*")
          DETECTED_PORT=""

          for port in "\${PORTS[@]}"; do
              if ls \$port &> /dev/null; then
                  DETECTED_PORT=\$(ls \$port 2>/dev/null | head -1)
                  break
              fi
          done

          if [ -n "\$DETECTED_PORT" ]; then
              echo "üîå Detected port: \$DETECTED_PORT"
              PORT_ARG="--port \$DETECTED_PORT"
          else
              echo "‚ö†Ô∏è  No port detected, you may need to specify it manually"
              PORT_ARG=""
          fi

          echo ""
          echo "üöÄ Ready to flash. Press Enter to continue or Ctrl+C to cancel..."
          read -r

          echo "Flashing bootloader components..."
          $ESP_TOOL --chip $TARGET \$PORT_ARG write_flash \
            0x2000 bootloader-${{ github.event.inputs.version }}-${{ matrix.board }}-bootloader.bin \
            0x10000 bootloader-${{ github.event.inputs.version }}-${{ matrix.board }}-partition-table.bin \
            0x20000 bootloader-${{ github.event.inputs.version }}-${{ matrix.board }}-factory.bin \
            0x128000 bootloader-${{ github.event.inputs.version }}-${{ matrix.board }}-ota-data.bin

          if [ \$? -eq 0 ]; then
              echo ""
              echo "‚úÖ Flashing completed successfully!"
              echo "üöÄ Your ESP32-P4 should now boot into the graphical bootloader"
              echo ""
              echo "üåê Web interface: https://georgik.github.io/esp32-p4-graphical-bootloader/"
              echo "üìñ Documentation: https://github.com/georgik/esp32-p4-graphical-bootloader"
          else
              echo ""
              echo "‚ùå Flashing failed!"
              echo "üí° Please check:"
              echo "   - Device is connected properly"
              echo "   - Device is in flash mode (hold BOOT button while pressing RESET)"
              echo "   - No other processes are using the serial port"
              exit 1
          fi
          EOF
          chmod +x firmware/flash-${{ matrix.board }}.sh

      - name: Upload Release Assets using gh
        run: |
          # Upload all release assets using gh CLI
          echo "Uploading release assets..."

          # Upload bootloader binary
          gh release upload "${{ github.event.inputs.version }}" \
            firmware/bootloader-${{ github.event.inputs.version }}-${{ matrix.board }}-bootloader.bin \
            --clobber

          # Upload partition table
          gh release upload "${{ github.event.inputs.version }}" \
            firmware/bootloader-${{ github.event.inputs.version }}-${{ matrix.board }}-partition-table.bin \
            --clobber

          # Upload factory application
          gh release upload "${{ github.event.inputs.version }}" \
            firmware/bootloader-${{ github.event.inputs.version }}-${{ matrix.board }}-factory.bin \
            --clobber

          # Upload OTA data
          gh release upload "${{ github.event.inputs.version }}" \
            firmware/bootloader-${{ github.event.inputs.version }}-${{ matrix.board }}-ota-data.bin \
            --clobber

          # Upload package
          gh release upload "${{ github.event.inputs.version }}" \
            firmware/bootloader-${{ github.event.inputs.version }}-${{ matrix.board }}.tar.gz \
            --clobber

          # Upload flash script
          gh release upload "${{ github.event.inputs.version }}" \
            firmware/flash-${{ matrix.board }}.sh \
            --clobber

          echo "All release assets uploaded successfully!"